<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Add Item Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005a87;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Comprehensive Add Item Test</h1>
    
    <div class="test-section">
        <h2>Step-by-Step Test</h2>
        <p>This test will walk through each step of the Add Item process.</p>
        
        <button id="step1">Step 1: Check DOM Elements</button>
        <div id="step1-result"></div>
        
        <button id="step2">Step 2: Simulate Product Search</button>
        <div id="step2-result"></div>
        
        <button id="step3">Step 3: Simulate Product Selection</button>
        <div id="step3-result"></div>
        
        <button id="step4">Step 4: Simulate Add Item Click</button>
        <div id="step4-result"></div>
        
        <button id="step5">Step 5: Verify Invoice Items</button>
        <div id="step5-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Complete Integration Test</h2>
        <button id="integration-test">Run Complete Integration Test</button>
        <div id="integration-result"></div>
    </div>
    
    <script>
        // Global variables for testing
        let testInvoiceItems = [];
        let testCurrentSelectedProduct = null;
        let testSearchResults = [];
        
        // DOM elements for testing
        let testProductSearchInput, testSearchResultsDiv, testQuantityInput, testAddItemBtn, testInvoiceItemsBody;
        
        // Step 1: Check DOM Elements
        document.getElementById('step1').addEventListener('click', function() {
            const resultDiv = document.getElementById('step1-result');
            resultDiv.innerHTML = '<p>Checking DOM elements...</p>';
            
            // Create test elements
            testProductSearchInput = document.createElement('input');
            testProductSearchInput.id = 'product-search-input';
            testProductSearchInput.type = 'text';
            
            testSearchResultsDiv = document.createElement('div');
            testSearchResultsDiv.id = 'search-results';
            
            testQuantityInput = document.createElement('input');
            testQuantityInput.id = 'quantity-input';
            testQuantityInput.type = 'number';
            testQuantityInput.value = '1';
            
            testAddItemBtn = document.createElement('button');
            testAddItemBtn.id = 'add-item-btn';
            testAddItemBtn.textContent = 'Add Item';
            
            testInvoiceItemsBody = document.createElement('tbody');
            testInvoiceItemsBody.id = 'invoice-items-body';
            
            // Add to body temporarily
            document.body.appendChild(testProductSearchInput);
            document.body.appendChild(testSearchResultsDiv);
            document.body.appendChild(testQuantityInput);
            document.body.appendChild(testAddItemBtn);
            document.body.appendChild(testInvoiceItemsBody);
            
            // Check if elements exist
            const elements = [
                { name: 'product-search-input', element: testProductSearchInput },
                { name: 'search-results', element: testSearchResultsDiv },
                { name: 'quantity-input', element: testQuantityInput },
                { name: 'add-item-btn', element: testAddItemBtn },
                { name: 'invoice-items-body', element: testInvoiceItemsBody }
            ];
            
            let allFound = true;
            elements.forEach(item => {
                if (item.element) {
                    resultDiv.innerHTML += `<p class="success">✓ ${item.name} found</p>`;
                } else {
                    resultDiv.innerHTML += `<p class="error">✗ ${item.name} NOT found</p>`;
                    allFound = false;
                }
            });
            
            if (allFound) {
                resultDiv.innerHTML += '<p class="success">✓ All DOM elements are present</p>';
            } else {
                resultDiv.innerHTML += '<p class="error">✗ Some DOM elements are missing</p>';
            }
        });
        
        // Step 2: Simulate Product Search
        document.getElementById('step2').addEventListener('click', function() {
            const resultDiv = document.getElementById('step2-result');
            resultDiv.innerHTML = '<p>Simulating product search...</p>';
            
            // Simulate API response with exact format from our test
            const apiResponse = [
                {
                    "gst_rate": "18.00",
                    "name": "Product A",
                    "pack_size": "1 kg",
                    "product_id": 1,
                    "purchase_rate": "80.00",
                    "selling_rate": "100.00",
                    "sku": "PROD-A-001",
                    "stock_quantity": 64
                },
                {
                    "gst_rate": "12.00",
                    "name": "Product B",
                    "pack_size": "500 g",
                    "product_id": 2,
                    "purchase_rate": "45.00",
                    "selling_rate": "60.00",
                    "sku": "PROD-B-002",
                    "stock_quantity": 200
                }
            ];
            
            testSearchResults = apiResponse;
            resultDiv.innerHTML += `<p class="success">✓ Simulated search returned ${testSearchResults.length} products</p>`;
            resultDiv.innerHTML += '<pre>' + JSON.stringify(testSearchResults[0], null, 2) + '</pre>';
        });
        
        // Step 3: Simulate Product Selection
        document.getElementById('step3').addEventListener('click', function() {
            const resultDiv = document.getElementById('step3-result');
            resultDiv.innerHTML = '<p>Simulating product selection...</p>';
            
            if (testSearchResults.length === 0) {
                resultDiv.innerHTML += '<p class="error">✗ No search results available. Run Step 2 first.</p>';
                return;
            }
            
            // Select the first product
            testCurrentSelectedProduct = testSearchResults[0];
            
            // Update the search input
            if (testProductSearchInput) {
                testProductSearchInput.value = testCurrentSelectedProduct.name;
            }
            
            // Clear search results
            if (testSearchResultsDiv) {
                testSearchResultsDiv.innerHTML = '';
            }
            
            resultDiv.innerHTML += `<p class="success">✓ Selected product: ${testCurrentSelectedProduct.name}</p>`;
            resultDiv.innerHTML += '<pre>' + JSON.stringify(testCurrentSelectedProduct, null, 2) + '</pre>';
        });
        
        // Step 4: Simulate Add Item Click
        document.getElementById('step4').addEventListener('click', function() {
            const resultDiv = document.getElementById('step4-result');
            resultDiv.innerHTML = '<p>Simulating Add Item button click...</p>';
            
            if (!testCurrentSelectedProduct) {
                resultDiv.innerHTML += '<p class="error">✗ No product selected. Run Step 3 first.</p>';
                return;
            }
            
            try {
                const quantity = parseInt(testQuantityInput.value) || 1;
                resultDiv.innerHTML += `<p>Adding item with quantity: ${quantity}</p>`;
                
                // Check if product is already in invoice
                const existingItemIndex = testInvoiceItems.findIndex(item => item.product_id === testCurrentSelectedProduct.product_id);
                resultDiv.innerHTML += `<p>Existing item index: ${existingItemIndex}</p>`;
                
                if (existingItemIndex >= 0) {
                    // Update quantity if product already exists
                    testInvoiceItems[existingItemIndex].quantity += quantity;
                    resultDiv.innerHTML += '<p class="info">ℹ Updated existing item quantity</p>';
                } else {
                    // Add new item
                    const item = {
                        product_id: testCurrentSelectedProduct.product_id,
                        name: testCurrentSelectedProduct.name,
                        pack_size: testCurrentSelectedProduct.pack_size,
                        gst_rate: parseFloat(testCurrentSelectedProduct.gst_rate), // Convert to number
                        selling_rate: parseFloat(testCurrentSelectedProduct.selling_rate), // Convert to number
                        quantity: quantity
                    };
                    testInvoiceItems.push(item);
                    resultDiv.innerHTML += '<p class="success">✓ New item added successfully</p>';
                    resultDiv.innerHTML += '<pre>' + JSON.stringify(item, null, 2) + '</pre>';
                }
            } catch (error) {
                resultDiv.innerHTML += `<p class="error">✗ Error adding item: ${error.message}</p>`;
                console.error('Add item error:', error);
            }
        });
        
        // Step 5: Verify Invoice Items
        document.getElementById('step5').addEventListener('click', function() {
            const resultDiv = document.getElementById('step5-result');
            resultDiv.innerHTML = '<p>Verifying invoice items...</p>';
            
            if (testInvoiceItems.length === 0) {
                resultDiv.innerHTML += '<p class="info">ℹ No items in invoice</p>';
                return;
            }
            
            resultDiv.innerHTML += `<p class="success">✓ Found ${testInvoiceItems.length} item(s) in invoice</p>`;
            resultDiv.innerHTML += '<pre>' + JSON.stringify(testInvoiceItems, null, 2) + '</pre>';
        });
        
        // Complete Integration Test
        document.getElementById('integration-test').addEventListener('click', function() {
            const resultDiv = document.getElementById('integration-result');
            resultDiv.innerHTML = '<p>Running complete integration test...</p>';
            
            try {
                // Reset test data
                testInvoiceItems = [];
                testCurrentSelectedProduct = null;
                testSearchResults = [];
                
                // Step 1: Simulate product search
                resultDiv.innerHTML += '<p>Step 1: Product search...</p>';
                const apiResponse = [
                    {
                        "gst_rate": "18.00",
                        "name": "Product A",
                        "pack_size": "1 kg",
                        "product_id": 1,
                        "purchase_rate": "80.00",
                        "selling_rate": "100.00",
                        "sku": "PROD-A-001",
                        "stock_quantity": 64
                    }
                ];
                testSearchResults = apiResponse;
                
                // Step 2: Simulate product selection
                resultDiv.innerHTML += '<p>Step 2: Product selection...</p>';
                testCurrentSelectedProduct = testSearchResults[0];
                
                // Step 3: Simulate add item
                resultDiv.innerHTML += '<p>Step 3: Add item...</p>';
                const quantity = 2;
                const item = {
                    product_id: testCurrentSelectedProduct.product_id,
                    name: testCurrentSelectedProduct.name,
                    pack_size: testCurrentSelectedProduct.pack_size,
                    gst_rate: parseFloat(testCurrentSelectedProduct.gst_rate),
                    selling_rate: parseFloat(testCurrentSelectedProduct.selling_rate),
                    quantity: quantity
                };
                testInvoiceItems.push(item);
                
                // Step 4: Verify
                resultDiv.innerHTML += '<p>Step 4: Verification...</p>';
                if (testInvoiceItems.length > 0 && testInvoiceItems[0].quantity === 2) {
                    resultDiv.innerHTML += '<p class="success">✓ Integration test PASSED!</p>';
                    resultDiv.innerHTML += '<pre>' + JSON.stringify(testInvoiceItems[0], null, 2) + '</pre>';
                } else {
                    resultDiv.innerHTML += '<p class="error">✗ Integration test FAILED!</p>';
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<p class="error">✗ Integration test error: ${error.message}</p>`;
                console.error('Integration test error:', error);
            }
        });
    </script>
</body>
</html>